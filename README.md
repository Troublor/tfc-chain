# 基于以太坊的TFC-Chain

以太坊支持图灵完全的智能合约，因此TFC-Chain的大部分逻辑都可以在智能合约中实现。

## 共识协议

### Proof-of-Work (PoW)

PoW是以太坊主网用到的共识协议，主要特征有：

- 挖矿耗费资源较多
- 出块时间间隔不确定
- 安全性高
- 任何人都可以加入挖矿

### Proof-of-Authority (PoA)

PoA是以太坊支持的另一个共识协议，一般用于测试链和私有链，主要特征：

- 挖矿不耗费资源
- 出块时间间隔固定
- 新矿工必须通过既有矿工的投票后才可加入挖矿

**TFC-Chain使用PoA较为合适**，其挖矿不耗费资源，出块稳定。

## TFC币

由于私有链有其自身的原生货币（native currency），例如ETH。

因此我们可以在TFC-Chain上使用原生货币作为TFC。

如果使用PoA共识协议，挖矿不产生TFC。则私有链初始化时需要将21亿TFC分配给一个保留账户，每天释放的TFC从这个保留账户中转出并分账。

TFC-Chain上的交易将使用TFC支付交易手续费。

PoA也支持将交易手续费设为零。

## 设计方案

TFC-Chain，用户注册、提交扇区/种子、分账，ERC20体现等业务都可以在智能合约中实现。

### 用户注册

TFC-Chain上的账户不需要注册，只需要有一个密钥对即可。

对于手机用户的注册，智能合约内实现以下函数即可将地址和手机号绑定并保存在智能合约中（链上）。

```solidity
function bindPhoneNumber(address addr, string phoneNumber) public 
```

注册fnode/rnode账户同理。

### 提交扇区/种子

提交扇区同样需要实现以下智能合约函数：

```solidity
function submitSector(address miner_addr, string miner_id, string sector_id, string sector_afid) public
```

智能合约将扇区信息和账户联系起来并存储。

提交种子同理。

### 分账

由于以太坊上的智能合约不能自动触发执行，因此需要有一个链下节点周期性地（每日）调用智能合约中的分账函数：

```solidity
function distributeReward() public
```

### ERC20提现

用户调用以下智能合约函数以发起提现请求。

```solidity
function withdrawToErc20() public
```

链下需要有一个服务器监控是否有新的提现请求，如果有则进行ERC20铸币。

## 跨链互操作性

### 智能合约调用链下API

[Provable]([Provable - blockchain oracle service, enabling data-rich smart contracts](https://provable.xyz/)) 可以对基于以太坊的区块链提供一个链上链下交互的机制。

基本原理为：Provable维护一个监控进程，监控智能合约中函数调用所产生的事件，然后调用链下相应的API或其他服务，链下调用的结果会通过再次调用智能合约的``__callback``函数将结果传给智能合约。

## 查询

智能合约的函数在执行时可以触发事件（在链上留下log），查询的时候只需要检索这些log即可。

例如，分账函数可以触发一个事件并在链上留下log。检索这些log即是账户的收益流水。

## 开发计划

### 区块链

区块链的架构无需开发，只需要部署一个私有链，需要花费的时间<1天。

### 智能合约

TFC-Chain的开发主要在于智能合约的编写（以下计划不包括智能合约开发的学习时间）。

- 第一周：
  - 确定用户信息在智能合约中存储的数据结构
  - 实现相关用户注册的函数。
  - 确定用户提交的扇区和种子在智能合约中如何和用户信息绑定。
- 第二周：
  - 设计简洁高效的提交事件。这些事件在提交扇区/种子时触发并在链上留下log，以供未来查询。
  - 实现提交扇区/种子的函数。
  - 编写一个自动化压力测试脚本，模拟真实提交扇区/种子的频率，在单节点私有链上测试交易处理性能和空间占用。
- 第三周：
  - 实现分账逻辑。
  - 在分账函数中设计可供查询分账记录的事件。
  - 分账函数需要链下每天主动调用来触发分账，使用Provable服务或编写后台常驻脚本以周期调用合约。
  - 扩充自动化压力测试脚本，增加分账的测试。
- 第四周：
  - 实现提现逻辑。
  - 在链下实现一个中转程序，监听TFC-Chain上提现的请求事件，并在以太坊上铸造TFC-ERC20代币。
  - 集成测试ERC20提现功能。
- 第五周：
  - 封装智能合约合约的调用，将以太坊调用的实现细节隐藏在RESTful API或SDK中，提供一个与TFC-DB一致的易于使用的接口。
  - 如果人手足够，此步骤可以与前四周的实现同步进行。

